{% extends "base.html" %}
{% load static %}

{% block title %}Project {{ project.number }}{% endblock %}
{% block extrahead %}
<style>
    .select2 {
        width: 100% !important;
    }

    .select2-container {
        min-width: 0 !important;
    }
</style>
{{ form.media }}
{{ merge_form.media }}
{% endblock %}

{% block content %}

{%if project != None%}
    <div class="card-deck">
        <div class="card col-sm-8">
            <div class="card-body">
                <h4 class="card-title">{{ project.number }}</h4>
                <h5 class="card-subtitle mb-2 text-muted">{% if project.title %}{{ project.title }}{% endif %}</h5>
                {% if project.project_scope %}
                <div class="card-text">{{ project.project_scope|safe|urlize|linebreaks }}</div>
                {% endif %}
            </div>
        </div>

        <div class="card col-sm-4 p-0">
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <a href="{% url 'todo:project_details_edit' %}" class="btn btn-primary">Edit Project</a>
                    <button class="btn btn-primary"
                            id="EditProjectButton"
                            type="button"
                            data-toggle="collapse"
                            data-target="#EditProject">
                        Edit Project
                    </button>
                </li>
                <li class="list-group-item">
                    <strong>Engineer:</strong>
                    {% if project.POR %} {{ project.POR.get_full_name }} {% else %} Anyone {% endif %}
                </li>
                <li class="list-group-item">
                    <strong>In Service Date:</strong>
                    {% if project.in_service_date %} {{ project.in_service_date }} {% else %} Anyone {% endif %}
                </li>
                <li class="list-group-item">
                    <strong>Stage:</strong>
                    {% if project.stage %} {{ project.stage }} {% else %} Anyone {% endif %}
                </li>
                <li class="list-group-item">
                    <strong>Location:</strong>
                    {% if project.location %} {{ project.location }} {% else %} Anyone {% endif %}
                </li>
            </ul>
        </div>
    </div>

{# Task edit / new task form #}
    <div id="EditProject" class="collapse">
        {% include 'todo/include/project_edit.html' %}
    </div>
    <hr />
{% endif %}


{% if hazards %}
    <div id="AddHazard" class="collapse">
        {% include 'todo/include/hazard_edit.html' %}
    </div>
    <hr />
    <button class="btn btn-primary"
            id="AddHazard"
            type="button"
            data-toggle="collapse"
            data-target="#AddHazard">
        Add Hazard
    </button>

    <table class="table" id="tasktable">
        <tr class="nodrop">
            <th>Hazard</th>
            <th>Created</th>
            <th>Due on</th>
            <th>Owner</th>
            <th>Assigned</th>
            <th>Mark</th>
        </tr>

        {% for hazard in hazards %}
        <tr id="{{ hazard.description }}">
            <td>
                <a href="{% url 'todo:hazard_details' project_id project_slug hazard.id %}">{{ hazard.description|truncatewords:10 }}</a>
            </td>

            <td>
                {% if hazard.assigned_to %}{{ hazard.assigned_to }}{% else %}Anyone{% endif %}
            </td>
            <td>
                <form method="post" action="{% url "todo:task_toggle_done" project.id %}" role="form">
                    {% csrf_token %}
                    <button class="btn btn-info btn-sm" type="submit" name="toggle_done">
                        {% if view_completed %}
                        Not Done
                        {% else %}
                        Done
                        {% endif %}
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}

    </table>

    {% include 'todo/include/toggle_delete.html' %}

{% else %}
    <h4>No tasks on this list yet (add one!)</h4>
    {% include 'todo/include/toggle_delete.html' %}

{% endif %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'todo/js/jquery.tablednd_0_5.js' %}" type="text/javascript"></script>

<script type="text/javascript">
  function order_tasks(data) {
    // The JQuery plugin tableDnD provides a serialize() function which provides the re-ordered
    // data in a list. We pass that list as an object ("data") to a Django view
    // to save new priorities on each task in the list.
    $.post("{% url 'todo:reorder_tasks' %}", data, "json");
    return false;
  }

  $(document).ready(function () {
    // Initialise the task table for drag/drop re-ordering
    $("#tasktable").tableDnD();

    $('#tasktable').tableDnD({
      onDrop: function (table, row) {
        order_tasks($.tableDnD.serialize());
      }
    });

  });

  // When adding a task, change the text of the Add Task button
  function handleClick() {
    console.log(this.innerHTML);
    this.innerHTML = (this.innerHTML == 'Add Task' ? 'Cancel' : 'Add Task');
  }
  document.getElementById('AddTaskButton').onclick = handleClick;
</script>
{% endblock extra_js %}